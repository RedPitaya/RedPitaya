location /calib_app/files {

    alias /tmp/calib_app;

    dav_access user:rw group:rw all:rw;

    dav_methods PUT DELETE MKCOL COPY MOVE;
    autoindex on;
    autoindex_exact_size off;
    autoindex_localtime on;
}

location /calib_app_create_backup{
    add_header 'Access-Control-Allow-Origin' '*';
    add_header 'Access-Control-Allow-Credentials' 'true';
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
    add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
    add_header 'Content-type' 'text/plain; charset=utf-8';

    default_type text/plain;

    content_by_lua '
        -- Create backup directory if it doesn
        os.execute("mkdir -p /tmp/calib_app 2> /dev/null")
        
        -- Get force flag parameter from query string
        local args = ngx.req.get_uri_args()
        local factory_flag = args["factory"]
        local factory_param = ""
        
        -- Add -f flag if force parameter is present and not empty
        if factory_flag and factory_flag ~= "0" then
            factory_param = " -f"
        end
        
        -- Get board name and replace spaces with underscores
        local handle = io.popen("profiles -n 2>/dev/null | tr \\" \\" \\"_\\" | tr -d \\"\\n\\"")
        local board_name = handle:read("*a")
        handle:close()
        
        -- Use default name if board name is empty
        if board_name == "" then
            board_name = "unknown_board"
        end
        
        -- Create temporary backup file with optional force flag
        os.execute("calib -rb" .. factory_param .. " 1> /tmp/temp_backup.bin")
        
        local version = "00"
        local file = io.open("/tmp/temp_backup.bin", "rb")
        if file then
            file:seek("set", 32)  -- 33rd byte (0-based indexing)
            local byte = file:read(1)
            if byte then
                version = string.format("%02X", string.byte(byte))
            end
            file:close()
        end
        
        -- Get current timestamp
        local time_str = os.date("%Y%m%d_%H%M%S")
        
        -- Generate filename with board name, version and timestamp
        local filename = board_name .. "_v" .. version .. "_" .. time_str .. ".bin"
        local full_path = "/tmp/calib_app/" .. filename
        
        -- Move temporary file to final destination
        os.execute("mv /tmp/temp_backup.bin " .. full_path)
        
        -- Return generated filename
        ngx.say(filename)
    ';
}

location /calib_app_upload_backup{
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Credentials' 'true';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
        add_header 'Content-type' 'text/plain; charset=utf-8';

        client_body_buffer_size 1M;

        content_by_lua '

        if ngx.req.get_method() == "POST" then
            os.execute("mkdir -p /tmp/calib_app 2> /dev/null");
            local filename = "/tmp/calib_app/data.bin"
            local file = io.open(filename, "w");
            ngx.req.read_body();

            local request_body = ngx.req.get_body_data()
        
            if not request_body then
                local temp_file = ngx.req.get_body_file()
                if temp_file then
                    local f = io.open(temp_file, "rb")
                    request_body = f:read("*a")
                    f:close()
                else
                    ngx.say("ERROR: No data received")
                    ngx.exit(ngx.HTTP_BAD_REQUEST)
                    return
                end
            end

            -- Write received data to file
            local file = io.open(filename, "wb")
            if file then
                file:write(request_body)
                file:close()
            else
                ngx.say("ERROR: Cannot create file")
                ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
                return
            end

            -- Write backup to device using calib -wb
            local handle = io.popen("cat /tmp/calib_app/data.bin | calib -wb 2>&1; echo $?")
            local result = handle:read("*a")
            handle:close()

            -- Get exit code (last line of output)
            local exit_code = tonumber(result:match("(%d+)")) or 1

            if exit_code == 0 then
                ngx.say("OK")
            else
                ngx.say("ERROR: " .. exit_code)
                ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
            end
        else
            ngx.say("ERROR: Unsupported request method")
            ngx.exit(ngx.HTTP_METHOD_NOT_ALLOWED)
        end
        ';
}
